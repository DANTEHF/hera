# 库存记录（StockRecord）
库存记录因为不针对仓库、项目存储，所以记录中不用判断出库入库，而只有从哪里到
哪里的记录。

具体对于一个项目是出库还是入库，是使用查询语句的时候，确定的。

写成SQL就是 
`select * from StockRecord where outStock = '项目A'` 
可以查询项目A的所有出库记录。
`select * from StockRecord where inStock = '项目A'` 
可以查询项目A的所有入库记录。

发料单，归料单这两个对应概念，一条发料单必然有一条归料单，反之亦然。
销售单，采购单以及报废单，他们都是独立的。

这些内容都会生成对应的出入库记录，而且根据情况的变化生成不一样的出入库记录。
现在列举如下：
- 调拨单，从基地调拨到项目A，产生一条出入库记录。（从基地到A）
- 调拨单，从项目A调拨到项目B，产生两条出入库记录。（从项目A到基地，从基地到项目A）
- 采购单，从外部进入基地，产生一条出入库记录。（从外部到基地）
- 采购单，从外部进入项目A，产生两条出入库记录。（从外部到基地，从基地到项目A）
- 销售单，从基地进入外部，产生一条出入库记录。（从基地到外部）
- 报废单，从基地进入外部，产生一条出入库记录。（从基地到外部）

在查询的时候，从数据库存中的 original 字段中获取对应的单据的
具体内容，而更新的时候，不覆盖原本的单据存储，而是新建一条，但
是库存记录保存最新的数据，使 original 字段指向最新的一条单据。
同时也添加到 originals 字段中。

删除操作分成两种，一种是将库存信息和对应的单据条目一并删除，另
一种是将库存信息设置成已删除，但是不真正删除该条目。

这个是在还没有加索引的情况下，具体使用应该根据情况加索引，但是还不确定索引应该
加在哪里。

查询的时候，用类似下面这样的代码查询
在服务器上 1个cpu 1G 内存的情况下，查询 1万条 每条 40 个条目的情况下，
一共使用的时间是 596 毫秒（包含测试启动输出的时间是 1.149 秒）
在自己的mac上，查询2.9万条数据，但是只有一部分数据是 40 个条目，具体不清
用时是 788 毫秒，包括测试启动输出是 1.44 秒。
```ecmascript 6
  return StockRecord.aggregate([
    {
      $match: {outStock: ObjectId(outStock)},
    },
    {
      $unwind: '$entries'
    },
    {
      $group: {
        _id: {
          name: '$entries.name',
          size: '$entries.size'
        },
        sum_of_it: {
          $sum: '$entries.count'
        }
      }
    }
  ]);
```

导出成csv 格式
` mongoexport --db hera --collection records --type=csv --fields _id > hello.csv`

目前权限这一块，系统中原本是几乎没有做，只做了认证，没有做授权管理。
这一块是我觉得没必要现在引入的内容，毕竟整个系统还是接近于原型系统，没有什么实用价值。

不过同样我也错了，为了引入不同的部门和层次，我需要正确实现权限系统。
就算只是用来区分人，也比现在这个情况要好很多。

按照我的想法，将系统分成两个层级，一个是总部，另一个是仓库和项目部。
总部可以代开各种内容，包括发料归料，修改查询，以及财务系统。

分部不进行财务操作，只上报。

在设计的时候，不对 api，进行改变，也就是原本 api 能做的事情，基本上不变。
但是 api 通过辨别传递进来的参数，进行选择要不要返回对应的数据。

另外同时考虑一些安全性的问题。

对现有的销售、采购进行调整。也就是他们都不单独确定单子。
要完全遵从一车一单的原则，而不对这个单子本身进行定性。
这个单子本身是做什么的，并不是定好的卖或者租，这个东西是放在字段中定义的。
这样子实际上我们可以在单子上做更丰富而且有趣有用的事情：
报损什么都记录在单子上面。

